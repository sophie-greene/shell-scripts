 #!/bin/bash


metapath="/media/sf_ubuntu/mp3/";

echo "extracting meta data from $1";

temp=$(exiftool -title "$1" | sed -e 's/  [ \t]\?//g');
title="${temp##*:}"
temp=$(exiftool -artist "$1" | sed -e 's/  [ \t]\?//g') ;
artist="${temp##*:}"
temp=$(exiftool -album "$1" | sed -e 's/  [ \t]\?//g') ;
album="${temp##*:}"
temp=$(exiftool -genre "$1" | sed -e 's/  [ \t]\?//g') ;
genre="${temp##*:}"
temp=$(exiftool -date "$1" | sed -e 's/  [ \t]\?//g') ;
date="${temp##*:}"
temp=$(exiftool -year "$1" | sed -e 's/  [ \t]\?//g') ;
year="${temp##*:}"
echo	"$title $artist $album $genre $date $year" ;
name="${1##*/}";
filename="$(echo "$artist" | sed -e's/[^a-zA-Z0-9]//g')-$(echo "$title" | sed -e's/[^a-zA-Z0-9]//g').mp3"
if [ -z "$title" ] ; then
	if [ -z "$artist" ] ; then 
		name="${1##*/}";
		filename="${name%.*}.mp3"
	fi
fi

if [ -f "$metapath$filename" ] ; then 
	echo ">>>>>>>>>>>>>>>>>>>>>>file $filename already exists in $metapath"
		
else
		
	echo "********************************processing file $filename....";	
	#create new metadata file 
	metanew="$metapath${name%.*}n.txt";
	#write new metadata

	echo ";FFMETADATA1">"$metanew";
	echo "Title= $title">>"$metanew";
	echo "Artist= $artist">>"$metanew";
	echo "Album= $album">>"$metanew";
	echo "Genre= $genre">>"$metanew";
	echo "Date= $date">>"$metanew";
	echo "Year= $year">>"$metanew";
	echo "new metadata file created.......";
	tempn="$metapath$name.mp3";


	ffmpeg -loglevel panic -i "$1"  -y -map_metadata -1 -map 0:0 -codec:a libmp3lame -q:a 2 "$tempn";
	ffmpeg  -i "$tempn" -i "$metanew" -map_metadata 1 -c:a copy -id3v2_version 3 -write_id3v1 1 "$metapath$filename" -y;
fi
rm "$tempn";
rm "$metanew";
:||{

path="${1%/*}";
name="${1##*/}";
ext="${1##*.}";

metadata="$metapath${name%.*}.txt";
metanew="$metapath${name%.*}n.txt";
temp="$metapath$name.mp3";
#read metadata in python
#-loglevel panic 
ffmpeg -i "$1"  -y -map 0:0 -codec:a libmp3lame -q:a 2 "$temp";
ffmpeg $(:-loglevel panic ) -i "$temp" -f  ffmetadata "$metadata";

counter=0;
#read tags from metadata file
declare -a val=();
declare -a tag=();
while read x ; 
	do :
	if [ $counter -gt 0 ]; then
		t="${x%=*}";
		val=("${val[@]}" "${x##*=}");
		tag=("${tag[@]}" "$t");
	fi;
		let counter+=1;
	
done < "$metadata";
#create new metadata file with the desired tags only

echo ";FFMETADATA1">"$metanew";
let s=${#tag[@]};
for (( i=0; i<$s; i++ ));
do
   :

case "${tag[$i]}" in
	("title") echo "${tag[$i]}= ${val[$i]}">>"$metanew" && title=$(echo "${val[$i]}" | sed 's/[^a-zA-Z0-9]//g');;
    	("artist") echo "${tag[$i]}= ${val[$i]}">>"$metanew" && artist=$(echo "${val[$i]}" | sed 's/[^a-zA-Z0-9]//g');;
    	("album") echo "${tag[$i]}= ${val[$i]}">>"$metanew" ;;
	("genre") echo "${tag[$i]}= ${val[$i]}">>"$metanew" ;;
	("date") echo "${tag[$i]}= ${val[$i]}">>"$metanew" ;;
    	(*) ;;
  esac
   
done;
out="$metapath$artist-$title.mp3";
echo "out**********************************$out"
ffmpeg -loglevel panic -i "$temp" -i "$metanew" -map_metadata 1 -map 0:0 -c:a copy -id3v2_version 3 -write_id3v1 1 "$out" -y;
rm "$temp";
rm "$metanew";
rm "$metadata";
}
